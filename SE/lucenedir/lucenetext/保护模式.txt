保护模式

保护模式（，或有时简写为 pmode）是一种80286系列和之后的x86兼容CPU的操作模式。保护模式有一些新的特性，如记忆体保护，分页系统以及硬体支援的虚拟记忆体，能够增强多任务处理和系统稳定度。现今大部分的x86作业系统都在保护模式下运行，包含Linux、FreeBSD、以及微软Windows 2.0和之后版本。

另外一种286和其之后CPU的操作模式是真实模式，这是一种向前相容且关闭了保护模式这些特性的CPU运行模式，用来让新的晶片可以执行旧的软体。所有的x86 CPU都是在真实模式下开机，来确保传统作业系统的相容性。为了使用保护模式的特性，要由程式主动地切换到保护模式。在现今的电脑上，这种切换通常是作业系统在开机时候完成的第一件工作。当CPU在保护模式下运行时，可以使用虚拟86模式来执行为真实模式设计的程式码。

尽管用软体的方式也有某些可能在真实模式的系统下使用多工，但保护模式下记忆体保护的特色，可以避免有问题的程式破坏其他工作或是作业系统核心所拥有的记忆体。保护模式也有中断正在执行程式的硬体支援，可以实现先占式多工。

大部分可以使用保护模式的CPU也拥有32位元暂存器的特性（例如80386系列和其后任何的晶片），导入了融合保护模式而成为32位元处理的概念。80286晶片虽有支援保护模式，但是仍然只有16位元暂存器。Windows 2.0和之后版本中的保护模式增强称为"386增强模式"，是因为他们除了保护模式外，还需要32位元的暂存器，并且无法在286上面执行（即使286支援保护模式）。

即使在32位元晶片上已经打开了保护模式，但是为了仿照IBM XT系统记忆体连续的设计特性，1 MiB以上的记忆体并无法存取。这种限制可以由打开A20总线来回避。

在保护模式下，前面32个中断都是保留给CPU例外处理用。例如，中断0D（十进制13）是一般保护模式错误，而中断00是除以零。

286出现之前，x86的地址总线为20位，使用16位的段基址（段首地址的高16位）与16位的段内偏移量，段基址左移4位后与段内偏移量相加形成20位的物理地址，来对2（即1MiB）的地址空间寻址。1982年问世的286 CPU首次使用了保护模式寻址。286 CPU的地址总线为24位，寻址空间为2（即16 MiB）。而286 CPU的寄存器仍为16位。寻址时，段寄存器保存的数据不再是内存物理地址，而是称作选择器（selector），其中高13位指向描述符表（descriptor table）的条目；最低的两位数据定义了请求的权限，从0到3，0是最高权限，3是最低权限；剩下的一位表示是使用（GDT）还是（LDT）。描述符表的条目为8字节长，包括24位长的段起始物理地址、16位长的段长（因此段的长度范围从1 B到2 B，即不超过64 KiB）。每次内存操作所要访问的物理地址为描述符表相应条目给出的24位段起始物理地址再加上16位的偏移量。可见，286保护模式下的应用程序能访问的内存线性地址空间仅为64 KB，非常有限。所以程序员编写使用大内存的应用程序时还必须使用远指针、近指针，相当繁琐。这影响了286保护模式的推广使用。

1985年问世的80386开启了32位CPU时代。地址总线为32比特，寻址空间为2（即4 GiB）。386 CPU保护模式下有两种内存寻址方式：

386 CPU开创的分页内存管理，比286保护模式寻址具有更多的优点：

IA32的CPU通过两级：页目（page directory）与页表（page table）实现4 KiB的分页管理，这是最常见的IA32分页寻址方式。CR3寄存器保存了进程的页目的物理地址。页目与页表中每4字节为一个单元，是一个32位的值，当页目项第0位为1时，表明页表已经在物理内存中；当页表项第0位为1时，表明访问的数据已经在内存中。另外，当页目项第7位为1时，表明这是一个4M的页面，这值已经是物理页地址，用虚拟地址的低22位作为偏移量。

从应用程序角度，不再使用段地址寄存器（或称选择器），仅使用32位的偏移量，为2（即4 GiB）的连续线性寻址空间。


